data_dir: ./data/vector

api:
  enabled: true
  address: 0.0.0.0:8686

sources:
  dnstap_tcp_listener:
    type: dnstap
    address: 0.0.0.0:9053
    mode: tcp

  vector_agent:
    type: vector
    address: 0.0.0.0:9054
    
  vector_logs:
     type: internal_logs

  vector_metrics:
    type: internal_metrics

transforms:
  vector_source:
    type: remap
    inputs:
      - vector_logs
    source: |
      .log_type = "raw"
      .service_name = "vector"

  named_source:
    type: remap
    inputs:
      - vector_agent
    source: |
      .log_type = "raw"
      .service_name = "named"  

  coredns_source:
    type: remap
    inputs:
      - dnstap_tcp_listener
    source: |

      message = .
      .= {}

      .log_type = "raw"
      .service_name = "coredns"
      .role = null

      if exists(message.requestData) {
            .data = message.requestData
            .rcodeName = message.requestData.rcodeName
            .qname = message.requestData.question[0].domainName
            .qtype = message.requestData.question[0].questionType
            .id = message.requestData.header.id
      }

      if exists(message.responseData) {
            .data = message.responseData
            .rcodeName = message.responseData.rcodeName
            .qname = message.responseData.question[0].domainName
            .qtype = message.responseData.question[0].questionType
            .id = message.responseData.header.id
      }
      . |= parse_regex!(message.messageType,r'(?<role>\w+)(?<message_type>Query|Response)')
      . |= parse_regex!(.qname,r'^(?<qname>[^.]+\.(?P<zone>.+?)).$')
      .proto = message.socketProtocol
      .src = message.responseAddress
      .dst = message.sourceAddress
      .host = message.host
      .timestamp = message.timestamp

  # New transforms: group ClientQuery and ClientResponse into a single transaction
  # Reduce messages by `id` (and qname and qtype) within 30s window, then remap to a
  # single `client_txn` event. This does not change existing transforms; it
  # consumes `coredns_source` as requested.
  client_txn_reduce:
    type: reduce
    inputs:
      - coredns_source
      - named_source
    group_by:
      - id
      - qname
      - qtype
      - role
    merge_strategies:
      messageType: array
      qname: discard
      qtype: array
      rcodeName: retain
      timestamp: flat_unique
    expire_after_ms: 30000
    flush_period_ms: 30000
    end_every_period_ms: 30000

  client_txn_remap:
    type: remap
    inputs:
      - client_txn_reduce
    source: |
      msg = .
      . = {}
      .log_type = "aggregated"
      .id = msg.id
      .src = msg.src
      .dst = msg.dst
      .rcode = msg.rcodeName
      .zone = msg.zone
      .qname = msg.qname
      .service_name = "vector"
      .message_type = msg.message_type
      .role = msg.role
      .timestamp = msg.timestamp

      if msg.qtype != null && length!(msg.qtype) > 0 {
        .qtype = msg.qtype[0]
      } else {
        .qtype = null
      }

      # earliest and latest timestamps if present
      if msg.timestamp != null && length!(msg.timestamp) > 0 {
        # keep raw values for inspection
        .first_ts = parse_timestamp!(msg.timestamp[0], format: "%Y-%m-%dT%H:%M:%S%.fZ")
        .last_ts = parse_timestamp!(msg.timestamp[-1], format: "%Y-%m-%dT%H:%M:%S%.fZ")
        .rtt = (to_float(.last_ts) - to_float(.first_ts)) 
      }

  metric_avg_rtt_reduce:
    type: reduce
    inputs:
      - client_txn_remap
    group_by:
      - zone
      - role
    merge_strategies:
      rtt: sum
      id: array
    expire_after_ms: 60000
    flush_period_ms: 60000
    end_every_period_ms: 60000

  metric_avg_rtt_remap:
    type: remap
    inputs:
      - metric_avg_rtt_reduce
    source: |
      msg = .
      . = {}
      .zone = msg.zone
      .field_name = replace(replace!(msg.zone, ".","_"),"-","_")
      .count = length!(msg.id)
      .rtt = msg.rtt
      .avg_rtt, _ =  length!(msg.id) / msg.rtt 

  metric_avg_rtt:
    type: log_to_metric
    inputs:
      - metric_avg_rtt_remap
    metrics:
      - type: gauge
        field: rtt
        name: "{{ .field_name }}"
        namespace: rtt
        tags:
          zone: "{{ .zone }}"
          role: "{{ .role }}"

  metric_zone_query_count:
    type: log_to_metric
    inputs:
      - metric_avg_rtt_remap
    metrics:
      - type: gauge
        field: count
        name: "{{ .field_name }}"
        namespace: count
        tags:
          zone: "{{ .zone }}"
          role: "{{ .role }}"
            
  f_dns_reduce:
    type: reduce
    inputs:
      - client_txn_remap
    group_by:
    - qname
    - qtype
    - rcode
    - role
    merge_strategies:
      id: array
      rtt: sum
      message_type: array
      timestamp: flat_unique
      role: discard
    expire_after_ms: 30000
    flush_period_ms: 30000
    end_every_period_ms: 30000

  f_dns:
    type: remap
    inputs:
      - f_dns_reduce
    source: |
      message = .
      . = {}
      .service_name = "aggregator"
      .log_type = "aggregated"
      .qname = message.qname
      .src = message.src
      .dst = message.dst
      .qtype = message.qtype
      .rcode = message.rcode
      .count = length!(message.id)
      .role = message.role
      .last_timestamp = message.timestamp[-1]
      .delta = 30
      .zone = message.zone

  metric_f_dns_remap:
    type: remap
    inputs:
      - f_dns
    source: |
      msg = .
      . = {}
      .zone = msg.zone
      .qtype = msg.qtype
      .count = msg.count
      .rcode = msg.rcode
      .role = msg.role
      .field_name = replace(replace!(msg.qname, ".","_"),"-","_")    

  metric_f_dns:
    type: log_to_metric
    inputs:
      - metric_f_dns_remap
    metrics:
      - type: gauge
        field: count
        name: "{{ .field_name }}"
        namespace: qname
        tags:
          zone: "{{ .zone }}"
          role: "{{ .role }}"
          qtype: "{{ .qtype }}"
          rcode: "{{ .rcode }}"

sinks:
  # console:
  #   inputs: []
  #   type: console
  #   encoding:
  #     codec: json
  #     json:
  #       pretty: true
  
  dnstap_file:
    type: file
    inputs:
      - coredns_source
      - named_source
    path: /tmp/dnstap_raw.jsonl
    encoding:
      codec: json
  
  loki_sink:
    type: loki
    inputs:
      - coredns_source
      - named_source
      - f_dns
      - vector_source
    encoding:
      codec: json
    labels:
      service_name: "{{ .service_name }}"
      log_type: "{{ .log_type }}"
    endpoint: http://loki:3100
  
  mimir_sink:
    type: prometheus_remote_write
    inputs:
      - metric_avg_rtt
      - metric_zone_query_count
      - metric_f_dns
      - vector_metrics
    endpoint: "http://mimir:9090/api/v1/push"
    healthcheck:
      enabled: false
