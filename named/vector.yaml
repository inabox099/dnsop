api:
  enabled: true
  address: 0.0.0.0:8686
  
sources:
  dnstap_socket:
    type: dnstap
    mode: unix
    max_frame_length: 102400
    socket_file_mode: 508
    socket_path: /run/dnstap.sock
    max_frame_handling_tasks: 10000
    

transforms:
  dnstap_source:
    type: remap
    inputs:
      - dnstap_socket
    source: |

      message = .
      .= {}

      .log_type = "raw"
      .service_name = "named"

      if exists(message.requestData) {
            .data = message.requestData
            .rcodeName = message.requestData.rcodeName
            .qname = message.requestData.question[0].domainName
            .qtype = message.requestData.question[0].questionType
            .id = message.requestData.header.id
      }

      if exists(message.responseData) {
            .data = message.responseData
            .rcodeName = message.responseData.rcodeName
            .qname = message.responseData.question[0].domainName
            .qtype = message.responseData.question[0].questionType
            .id = message.responseData.header.id
      }
      . |= parse_regex!(message.messageType,r'(?<role>\w+)(?<message_type>Query|Response)')
      . |= parse_regex!(.qname,r'^(?<qname>[^.]+\.(?P<zone>.+?)).$')
      .proto = message.socketProtocol
      .src = message.responseAddress
      .dst = message.sourceAddress
      .host = message.host
      .timestamp = message.timestamp

sinks:
  console_out:
    type: console
    inputs:
      - dnstap_source
    encoding:
      codec: json
  my_sink_id:
    type: vector
    inputs:
      - dnstap_source
    address: 10.10.1.40:9054